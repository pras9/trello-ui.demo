APP_CONST={DATA_PATH:"data",API_BOARD:"data/board.json",API_LISTS:"data/lists.json",API_USER:"data/user.json",API_ACTIVITIES:"data/activity.json"};var utils=function(global,doc,$){"use strict";var utils={};return utils.loadTemplate=function(a,b){var c=$("script#"+a+"_view").html(),d=_.template(c,{imports:{jq:$}});return d(b)},utils.__extends=function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},utils.str2ClassName=function(a){var b="",c=a.split("_"),d=0;for(d=0;d<c.length;d++)b+=c[d].charAt(0).toUpperCase()+c[d].slice(1);return b},utils.str2Class=function(str){var className=this.str2ClassName(str);if(!global.hasOwnProperty(className))throw new Error("Class "+className+" does not exists!");return eval(className)},utils}(window,document,jQuery),Provider=Provider||{};Provider.Router=function(a,b,c){"use strict";function d(){this.CLASS_NAME="Router",this.routes={},this.listenToChange()}return d.prototype.addRoute=function(a,b){this.routes[a]=b},d.prototype.delRoute=function(a){return this.routes.hasOwnProperty(a)&&delete this.routes[a],this},d.prototype.listenToChange=function(){var b,d=this;return c(a).on("hashchange",function(){b=app.getHash(),d.routes.hasOwnProperty(b)&&d.routes[b]()}),this},d}(window,document,jQuery);var Provider=Provider||{};Provider.Service=function(a,b,c){"use strict";function d(){this.CLASS_NAME="Service",this.cache={},this.storage=a.localStorage}return d.prototype.get=function(a){var b={};return c.ajax({type:"GET",url:a,dataType:"json",async:!1,success:function(a){b=a},error:function(a){console.log(a)}}),b},d.prototype.getBoardDetail=function(a){var b={},c={},d="boards-details";return null!=this.cache[d]?b=this.cache[d]:null!=this.storage.getItem(d)?(b=JSON.parse(this.storage.getItem(d)),this.cache[d]=b):(b=this.get(APP_CONST.API_BOARD),this.cache[d]=b,this.storage.setItem(d,JSON.stringify(b))),c=_.find(b,function(b){return b.id===a})},d.prototype.getBoardLists=function(a){var b={},d={},e="lists-details",f=[],g=[];return null!=this.cache[e]?d=this.cache[e]:null!=this.storage.getItem(e)?(d=JSON.parse(this.storage.getItem(e)),this.cache[e]=d):(b=this.get(APP_CONST.API_LISTS),c.each(b,function(a,b){f.push({id:b.id,name:b.name,created:b.created,owner:b.owner,boardId:b.boardId,order:b.order,status:b.status}),c.each(b.cards,function(a,c){c.listId=b.id,g.push(c)})}),this.cache[e]=f,this.cache["cards-details"]=g,this.storage.setItem(e,JSON.stringify(f)),this.storage.setItem("cards-details",JSON.stringify(g)),d=f),_.filter(d,function(b){return b.boardId===a})},d.prototype.getCards=function(a){var b={},c="cards-details";return null!=this.cache[c]?b=this.cache[c]:(b=JSON.parse(this.storage.getItem(c)),this.cache[c]=b),_.filter(b,function(b){return b.listId===a})},d.prototype.addList=function(a){var b,c="lists-details",d=[],e=(new Date).getTime();return d=null!=this.cache[c]?this.cache[c]:JSON.parse(this.storage.getItem(c)),b=_.result(_.max(d,function(a){return a.id}),"id"),d.push({id:b+1,name:a,created:e,owner:app.currentUserId,boardId:app.boardId,order:d.length+1,status:1}),this.cache[c]=d,this.storage.setItem(c,JSON.stringify(d)),this.addActivity({user:app.currentUserId,actionType:"added",object:"list",objectTitle:a,timestamp:e}),b+1},d.prototype.setListName=function(a,b){var d="lists-details",e=[];return e=null!=this.cache[d]?this.cache[d]:JSON.parse(this.storage.getItem(d)),c.each(e,function(c,d){d.id===a&&(e[c].name=b)}),this.cache[d]=e,this.storage.setItem(d,JSON.stringify(e)),this},d.prototype.getMenuActivities=function(){var a,b="user-activity",c={};return null!=this.storage.getItem(b)?c=JSON.parse(this.storage.getItem(b)):(a=this.get(APP_CONST.API_ACTIVITIES),c=_.sortByOrder(a,["timestamp"],!1),this.storage.setItem(b,JSON.stringify(c))),c},d.prototype.addActivity=function(a){var b="user-activity",c=[];null!=this.storage.getItem(b)?c=JSON.parse(this.storage.getItem(b)):(c=this.get(APP_CONST.API_ACTIVITIES),c=_.sortByOrder(c,["timestamp"],!1)),a.actionText=a.actionType+" "+a.object+' <a href="javascript:void(0);">'+a.objectTitle.substring(0,19)+"</a>",c.unshift({user:a.user,actionText:a.actionText,timestamp:null!=a.timestamp?a.timestamp:(new Date).getTime()}),this.storage.setItem(b,JSON.stringify(c)),app.menu.addActivity(a)},d.prototype.getUserDetail=function(a){var b,c="current-user",d={};return null!=this.cache[c]?d=this.cache[c]:null!=this.storage.getItem(c)?(d=JSON.parse(this.storage.getItem(c)),this.cache[c]=d):(b=this.get(APP_CONST.API_USER),d=_.find(b,function(b){return b.id===a}),this.cache[c]=d,this.storage.setItem(c,JSON.stringify(d))),d},d}(window,document,jQuery);var Board=function(a,b,c){"use strict";function d(){this.CLASS_NAME="Board",this.container="#board_container",this.template="board",this.list=new List,this.boardId=1}return d.prototype.bindEvents=function(){this.list.bindEvents()},d.prototype.buildUi=function(){var a=this;this.boardData=app.service.getBoardDetail(this.boardId),this.listsData=app.service.getBoardLists(this.boardId),c(this.container).html(utils.loadTemplate(a.template,{board_title:a.boardData.name})),c.each(this.listsData,function(b,c){a.list.buildUi(c)}),this.bindEvents()},d.prototype.init=function(a){this.boardId=null!=a?a:this.boardId,app.boardId=this.boardId,this.buildUi(),this.bindEvents()},d}(window,document,jQuery),List=function(a,b,c){"use strict";function d(){this.CLASS_NAME="List",this.template="card_list",this.beforeElement=".new-list",this.data=null,this.listHeader=".list-header",this.listHeaderText=".list-header > span",this.listRenameBlock=".list-rename",this.listRenameInput=".input-listname",this.listRenameSaveBtn=".list-rename .save-listname",this.listRenameCancelBtn=".list-rename .cancel-list-rename",this.addNewList=".list-adder",this.newListAddBlock=".new-list > .list-rename",this.newListSaveBtn=".new-list .save-listname",this.newListCancelBtn=".new-list .cancel-list-rename"}return d.prototype.bindEvents=function(){var a=this;c(this.listHeaderText).off("click").on("click",function(){c(this).parent().hide(),c(this).parent().parent().find(a.listRenameBlock).show().find(a.listRenameInput).val(c(this).text())}),c(this.listRenameSaveBtn).off("click").on("click",function(){var b=c(this).parent().find(a.listRenameInput).val(),d=c(this).parent().parent().find(a.listHeader).data("listid");null!=a.rename(d,b)&&c(this).parent().parent().find(a.listHeaderText).text(b),c(this).parent().hide(),c(this).parent().parent().find(a.listHeader).show()}),c(this.listRenameCancelBtn).off("click").on("click",function(){c(this).parent().hide(),c(this).parent().parent().find(a.listHeader).show()}),c(this.newListSaveBtn).off("click").on("click",function(){c(this).parent().hide(),c(a.addNewList).show(),a.add(c(this).parent().find(a.listRenameInput).val()),c(this).parent().find(a.listRenameInput).val("")}),c(this.newListCancelBtn).off("click").on("click",function(){c(this).parent().hide(),c(a.addNewList).show(),c(this).parent().find(a.listRenameInput).val("")}),c(this.addNewList).off("click").on("click",function(){c(a.newListAddBlock).show(),c(this).hide()})},d.prototype.buildUi=function(a){var b=this;if(null!=a&&(this.data=a),null==this.data)throw new Error("Cannot build ui for null list");this.data.cards=app.service.getCards(this.data.id),c(this.beforeElement).before(utils.loadTemplate(b.template,{listid:b.data.id,list_header:b.data.name,cards:b.data.cards}))},d.prototype.add=function(a){var b=app.service.addList(a);this.buildUi({id:b,name:a})},d.prototype.rename=function(a,b){return app.service.setListName(a,b)},d.prototype.archive=function(){},d.prototype.init=function(a){if(null==a)throw new Error("List cannot be initialized null");this.data=a,this.buildUi(),this.bindEvents()},d}(window,document,jQuery),Menu=function(a,b,c){"use strict";function d(){this.CLASS_NAME="Menu",this.container="#menu_container",this.template="menu",this.activityTemplate="activity",this.showMenuBtn="#show_activity_menu",this.hideMenuBtn="#hide_activity_menu",this.menuInnerContainer="#activity_menu_container",this.activityContainer=".activities"}return d.prototype.bindEvents=function(){var a=this;c(this.showMenuBtn).click(function(){setTimeout(function(){c(a.hideMenuBtn).show()},700),c(a.menuInnerContainer).show("slide",{direction:"right"},600)}),c(this.hideMenuBtn).click(function(){c(this).hide(),c(a.menuInnerContainer).hide("slide",{direction:"right"},600)})},d.prototype.buildUi=function(){var a,b,d=this,e={hour:"2-digit",minute:"2-digit",year:"numeric",month:"short",day:"numeric"};this.menuActivities=app.service.getMenuActivities(app.boardId),c.each(this.menuActivities,function(c,f){a=app.service.getUserDetail(f.user),d.menuActivities[c].userName=a.name,d.menuActivities[c].avatar=a.avatar,b=new Date(parseInt(f.timestamp)),d.menuActivities[c].timestamp=b.toLocaleTimeString("en-us",e)}),c(this.container).html(utils.loadTemplate(d.template,{activities:d.menuActivities})),this.bindEvents()},d.prototype.addActivity=function(a){var b=this,d=new Date(parseInt(a.timestamp)),e={hour:"2-digit",minute:"2-digit",year:"numeric",month:"short",day:"numeric"},f=app.service.getUserDetail(a.user);a.userName=f.name,a.avatar=f.avatar,a.timestamp=d.toLocaleTimeString("en-us",e),c(this.activityContainer).find("h4").after(utils.loadTemplate(b.activityTemplate,a))},d.prototype.init=function(){this.buildUi(),this.bindEvents()},d}(window,document,jQuery),app=function(a,b,c){"use strict";var d={boardId:1,service:new Provider.Service};return d.resizeAll=function(){c("body").css({height:c(window).height(),width:"100%"}),c("#body").css({height:parseInt(c(window).height())-40+"px"}),c("#activity_menu_container").css({height:parseInt(c(window).height())-40+"px"}),c("#lists_container").css({height:parseInt(c(window).height())-105+"px"}),c(".cards-container").css({"max-height":parseInt(c("#lists_container").css("height"))-(parseInt(c(".list-header:first").css("height"))+parseInt(c(".list-footer:first").css("height"))+60)+"px"})},d.getHash=function(){return a.location.hash.replace("#","")},d.updateHash=function(b){a.location.hash="#"+b},d.init=function(){this.board=new Board,this.board.init(),this.menu=new Menu,this.menu.init(),this.router=new Provider.Router,this.currentUserId=1,this.currentUser=this.service.getUserDetail(this.currentUserId),c(a).resize(d.resizeAll),this.resizeAll()},d}(window,document,jQuery);$(document).ready(function(){app.init()});